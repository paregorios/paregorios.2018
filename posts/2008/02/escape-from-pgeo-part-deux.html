<html><body><p>Last week, I posted a short bit on using <a href="http://www.gdal.org/ogr/ogrinfo.html">ogrinfo</a> and <a href="http://www.gdal.org/ogr/ogr2ogr.html">ogr2ogr</a> to <a href="http://horothesia.blogspot.com/2008/01/escape-from-pgeo.html">convert a layer in an ESRI personal geodatabase to a shapefile</a>. Today we'll automate the process with some python programming to extract all layers (regardless of geometry) from an arbitrary pgeo file.<br><br>The following examples assume you're running python within an <a href="http://fwtools.maptools.org/">FWTools</a> shell.<br><br><span style="font-weight: bold;">Get a list of layers</span><br><br>The first challenge is capturing the output from <span style="font-style: italic;">ogrinfo</span> (the list of layers) into a form we can parse. Python gives us a number of methods for issuing commands to the hosting system environment. The one to use here is <a href="http://docs.python.org/lib/os-newstreams.html#l2h-2616">popen3 from the os module</a> since it will let us invoke <span style="font-style: italic;">ogrinfo</span> and then work with its output (specifically stdout) as a file-like object in code. We'll read the output lines into <a href="http://docs.python.org/tut/node5.html#SECTION005140000000000000000">a python list</a> for subsequent processing.<br></p><pre>&gt;&gt;&gt; import os<br>&gt;&gt;&gt; infilename = "ItAntMapping.mdb"<br>&gt;&gt;&gt; child_stdin, child_stdout, child_stderr = os.popen3("ogrinfo %s" % infilenam<br>e)<br>&gt;&gt;&gt; output = child_stdout.readlines()<br>&gt;&gt;&gt; output<br>["INFO: Open of `ItAntMapping.mdb'\n", "      using driver `PGeo' successful.\n"<br>, '1: whollyimprecise\n', '2: placesAdded\n', '3: placesEstimated\n', '4: places<br>Solid\n', '5: stretchesDangling\n', '6: stretchesFloating\n', '7: stretchesSolid<br>\n', '8: tpPoints\n', '9: stretchesUnlocated\n']<br></pre>Now we want to cleanup this list of lines so we're left with a list of layer names (no prefixed numbers, no newline characters, no strings other than layer names). We'll iterate through each line in the output and, if a python regular expression designed to differentiate between layer names and <span style="font-style: italic;">ogrinfo</span>'s other outputs finds a match, we'll copy the relevant portion of the matched line into a new list of "layers". We'll need the python regular expression module (re) for this step.<br><br>In pseudocode:<br><ul><li>set up a regular expression to match a line that begins with a string of digits, a colon, and a space, followed by a string of arbitrary length and a newline (group the string that is the layer name)<br></li><li>create a new list to hold the layer names<br></li><li>for each line in the output list:<br><ul><li>attempt a regular expression match<br></li><li>if matched: append the contents of the group (the layer name) to the layers list</li></ul></li></ul>In python:<br><pre>import re<br>&gt;&gt;&gt; regex = re.compile('^\d+: (.*)\n')<br>&gt;&gt;&gt; layers = []<br>&gt;&gt;&gt; for line in output:<br>...     m = regex.match(line)<br>...     if m:<br>...         layers.append(m.groups()[0])<br>...<br>&gt;&gt;&gt; layers<br>['whollyimprecise', 'placesAdded', 'placesEstimated', 'placesSolid', 'stretchesD<br>angling', 'stretchesFloating', 'stretchesSolid', 'tpPoints', 'stretchesUnlocated<br>']<br></pre><span style="font-weight: bold;">Extract each named layer</span><br><br>Now the easy part. Iterate through the list of layers, invoking <span style="font-style: italic;">ogr2ogr</span> for each layer. We don't need to capture any i/o streams this time, so we'll just use the plain-vanilla <span style="font-style: italic;">system </span>method.<br><pre>&gt;&gt;&gt; for layer in layers:<br>...     os.system('ogr2ogr -f "ESRI Shapefile" %s.shp ItAntMapping.mdb %s' % (la<br>yer, layer))<br>...<br>&gt;&gt;&gt; ^Z<br>C:\Users\Tom\Documents\itins&gt;dir *.shp<br>Volume in drive C has no label.<br>Volume Serial Number is 2C47-654D<br><br>Directory of C:\Users\Tom\Documents\itins<br><br>02/04/2008  01:03 PM               156 placesAdded.shp<br>02/04/2008  01:03 PM             7,464 placesEstimated.shp<br>02/04/2008  01:03 PM            85,780 placesSolid.shp<br>02/04/2008  01:03 PM               100 stretchesDangling.shp<br>02/04/2008  01:03 PM               100 stretchesFloating.shp<br>02/04/2008  01:03 PM            62,420 stretchesSolid.shp<br>02/04/2008  01:03 PM             1,684 stretchesUnlocated.shp<br>02/04/2008  01:03 PM               100 whollyimprecise.shp<br>            8 File(s)      157,804 bytes<br>             0 Dir(s)  172,207,665,152 bytes free<br></pre><span style="font-weight: bold;">Package up the code</span><br><br>I've incorporated these steps into <a href="http://homepages.nyu.edu/%7Ete20/code/free.py">a python script</a>, along with some error handling and usage methods. It's a bit more generalized than what's shown above. Enjoy, and let me know about mistakes or suggestions for improvement.</body></html>